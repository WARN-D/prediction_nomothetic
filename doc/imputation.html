<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4 Imputation | Integrating ecological momentary and passive sensing data to improve depression severity prediction: insights from the WARN-D study</title>
  <meta name="description" content="4 Imputation | Integrating ecological momentary and passive sensing data to improve depression severity prediction: insights from the WARN-D study" />
  <meta name="generator" content="bookdown 0.45 and GitBook 2.6.7" />

  <meta property="og:title" content="4 Imputation | Integrating ecological momentary and passive sensing data to improve depression severity prediction: insights from the WARN-D study" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 Imputation | Integrating ecological momentary and passive sensing data to improve depression severity prediction: insights from the WARN-D study" />
  
  
  

<meta name="author" content="Rayyan Tutunji" />


<meta name="date" content="2025-11-03" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="descriptives.html"/>
<link rel="next" href="dataset-creation.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="libs/pagedtable-1.1/js/pagedtable.js"></script>
<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="data-prep.html"><a href="data-prep.html"><i class="fa fa-check"></i><b>2</b> Data Prep</a>
<ul>
<li class="chapter" data-level="2.1" data-path="data-prep.html"><a href="data-prep.html#processing"><i class="fa fa-check"></i><b>2.1</b> Processing</a></li>
<li class="chapter" data-level="2.2" data-path="data-prep.html"><a href="data-prep.html#compliance-estimates"><i class="fa fa-check"></i><b>2.2</b> Compliance Estimates</a></li>
<li class="chapter" data-level="2.3" data-path="data-prep.html"><a href="data-prep.html#data-merger"><i class="fa fa-check"></i><b>2.3</b> Data Merger</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="descriptives.html"><a href="descriptives.html"><i class="fa fa-check"></i><b>3</b> Descriptives</a>
<ul>
<li class="chapter" data-level="" data-path="descriptives.html"><a href="descriptives.html#demographics"><i class="fa fa-check"></i>Demographics</a></li>
<li class="chapter" data-level="" data-path="descriptives.html"><a href="descriptives.html#compliance-rates"><i class="fa fa-check"></i>Compliance Rates</a></li>
<li class="chapter" data-level="" data-path="descriptives.html"><a href="descriptives.html#feature-correlations"><i class="fa fa-check"></i>Feature Correlations</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="imputation.html"><a href="imputation.html"><i class="fa fa-check"></i><b>4</b> Imputation</a></li>
<li class="chapter" data-level="5" data-path="dataset-creation.html"><a href="dataset-creation.html"><i class="fa fa-check"></i><b>5</b> Dataset Creation</a>
<ul>
<li class="chapter" data-level="5.1" data-path="dataset-creation.html"><a href="dataset-creation.html#weekly-data"><i class="fa fa-check"></i><b>5.1</b> Weekly Data</a></li>
<li class="chapter" data-level="5.2" data-path="dataset-creation.html"><a href="dataset-creation.html#daily-data"><i class="fa fa-check"></i><b>5.2</b> Daily Data</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="dataset-export.html"><a href="dataset-export.html"><i class="fa fa-check"></i><b>6</b> Dataset Export</a></li>
<li class="chapter" data-level="7" data-path="model-testing.html"><a href="model-testing.html"><i class="fa fa-check"></i><b>7</b> Model Testing</a>
<ul>
<li class="chapter" data-level="7.1" data-path="model-testing.html"><a href="model-testing.html#model-predictions"><i class="fa fa-check"></i><b>7.1</b> Model Predictions</a></li>
<li class="chapter" data-level="7.2" data-path="model-testing.html"><a href="model-testing.html#shap-estimate"><i class="fa fa-check"></i><b>7.2</b> SHAP Estimate</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="results.html"><a href="results.html"><i class="fa fa-check"></i><b>8</b> Results</a></li>
<li class="chapter" data-level="9" data-path="model-performance.html"><a href="model-performance.html"><i class="fa fa-check"></i><b>9</b> Model Performance</a>
<ul>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#training-cv"><i class="fa fa-check"></i>Training CV</a></li>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#test-data"><i class="fa fa-check"></i>Test Data</a></li>
<li class="chapter" data-level="9.1" data-path="model-performance.html"><a href="model-performance.html#full-results"><i class="fa fa-check"></i><b>9.1</b> Full Results</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="idiographic-model-performance.html"><a href="idiographic-model-performance.html"><i class="fa fa-check"></i><b>10</b> Idiographic Model Performance</a></li>
<li class="chapter" data-level="11" data-path="shap.html"><a href="shap.html"><i class="fa fa-check"></i><b>11</b> SHAP</a>
<ul>
<li class="chapter" data-level="" data-path="shap.html"><a href="shap.html#top-10-daily"><i class="fa fa-check"></i>Top 10 Daily</a></li>
<li class="chapter" data-level="11.1" data-path="shap.html"><a href="shap.html#top-10-weekly"><i class="fa fa-check"></i><b>11.1</b> Top 10 Weekly</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="supp-analysis.html"><a href="supp-analysis.html"><i class="fa fa-check"></i><b>12</b> Supp Analysis</a>
<ul>
<li class="chapter" data-level="12.1" data-path="supp-analysis.html"><a href="supp-analysis.html#phq-9-autoregressive-model"><i class="fa fa-check"></i><b>12.1</b> PHQ-9 Autoregressive Model</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Integrating ecological momentary and passive sensing data to improve depression severity prediction: insights from the WARN-D study</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="imputation" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">4</span> Imputation<a href="imputation.html#imputation" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Here I use MICE for imputation, setting my imputation model to a random forest model at the within-subject levels. We include in this model all predictors, and we set outcomes and ID to 0 so we can exclude them from any predictions. We then check if any variables have a constant value. This occurs for example in some of the substance use items, or perhaps location items. So we fill those with the constant value the participants endorsed (or didn’t). Once that’s done, we exclude those predictors from our matrix as well, and then implement MICE.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="imputation.html#cb27-1" tabindex="-1"></a><span class="co"># Select non-composite EMA variable</span></span>
<span id="cb27-2"><a href="imputation.html#cb27-2" tabindex="-1"></a>ema_vars <span class="ot">=</span> <span class="fu">c</span>(ema_mor_vars, ema_day_vars, ema_eve_vars, categorical_items_d)</span>
<span id="cb27-3"><a href="imputation.html#cb27-3" tabindex="-1"></a><span class="co"># Now also select som EPA variables (subset sleep)</span></span>
<span id="cb27-4"><a href="imputation.html#cb27-4" tabindex="-1"></a>epa_vars <span class="ot">=</span> <span class="fu">c</span>(epa_day_hr, epa_day_stress, epa_sleep_vars, epa_day_act[<span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>,<span class="dv">7</span>,<span class="dv">8</span>)], epa_day_bat)</span>
<span id="cb27-5"><a href="imputation.html#cb27-5" tabindex="-1"></a><span class="co"># Vector of IVs of interest and n of features</span></span>
<span id="cb27-6"><a href="imputation.html#cb27-6" tabindex="-1"></a>impute_vars <span class="ot">=</span>  <span class="fu">c</span>(ema_vars, epa_vars)</span>
<span id="cb27-7"><a href="imputation.html#cb27-7" tabindex="-1"></a></span>
<span id="cb27-8"><a href="imputation.html#cb27-8" tabindex="-1"></a><span class="co"># Subset data</span></span>
<span id="cb27-9"><a href="imputation.html#cb27-9" tabindex="-1"></a>df_features <span class="ot">=</span> df_merge <span class="sc">%&gt;%</span></span>
<span id="cb27-10"><a href="imputation.html#cb27-10" tabindex="-1"></a>  <span class="fu">select</span>(external_id, week_nr, day_nr, prompt_num,</span>
<span id="cb27-11"><a href="imputation.html#cb27-11" tabindex="-1"></a>         phq9_sum_w, phq2_sum_e, <span class="fu">all_of</span>(impute_vars) )  <span class="sc">%&gt;%</span></span>
<span id="cb27-12"><a href="imputation.html#cb27-12" tabindex="-1"></a>  <span class="fu">filter</span>(prompt_num <span class="sc">!=</span> <span class="dv">5</span>) </span>
<span id="cb27-13"><a href="imputation.html#cb27-13" tabindex="-1"></a></span>
<span id="cb27-14"><a href="imputation.html#cb27-14" tabindex="-1"></a>run_imputation<span class="ot">=</span><span class="cn">FALSE</span></span>
<span id="cb27-15"><a href="imputation.html#cb27-15" tabindex="-1"></a>  <span class="cf">if</span> (run_imputation){</span>
<span id="cb27-16"><a href="imputation.html#cb27-16" tabindex="-1"></a>  <span class="co"># Define the path for your error log</span></span>
<span id="cb27-17"><a href="imputation.html#cb27-17" tabindex="-1"></a>  error_log_file <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;imputation_failures_&quot;</span>, <span class="fu">Sys.Date</span>(), <span class="st">&quot;.log&quot;</span>)</span>
<span id="cb27-18"><a href="imputation.html#cb27-18" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(error_log_file)) <span class="fu">file.remove</span>(error_log_file)</span>
<span id="cb27-19"><a href="imputation.html#cb27-19" tabindex="-1"></a>    </span>
<span id="cb27-20"><a href="imputation.html#cb27-20" tabindex="-1"></a>  <span class="co"># Progress bar set-up</span></span>
<span id="cb27-21"><a href="imputation.html#cb27-21" tabindex="-1"></a>  <span class="fu">library</span>(progress)</span>
<span id="cb27-22"><a href="imputation.html#cb27-22" tabindex="-1"></a>  pb <span class="ot">&lt;-</span> progress_bar<span class="sc">$</span><span class="fu">new</span>(<span class="at">format =</span> <span class="st">&quot;[:bar] :percent ETA: :eta&quot;</span>, <span class="at">total =</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_features<span class="sc">$</span>external_id)))</span>
<span id="cb27-23"><a href="imputation.html#cb27-23" tabindex="-1"></a>  progress <span class="ot">&lt;-</span> <span class="cf">function</span>(n){ pb<span class="sc">$</span><span class="fu">tick</span>()}</span>
<span id="cb27-24"><a href="imputation.html#cb27-24" tabindex="-1"></a>  opts <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">progress =</span> progress)</span>
<span id="cb27-25"><a href="imputation.html#cb27-25" tabindex="-1"></a>  </span>
<span id="cb27-26"><a href="imputation.html#cb27-26" tabindex="-1"></a>  <span class="co"># Parallel set-up</span></span>
<span id="cb27-27"><a href="imputation.html#cb27-27" tabindex="-1"></a>  n_cores <span class="ot">=</span> <span class="fu">detectCores</span>()<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb27-28"><a href="imputation.html#cb27-28" tabindex="-1"></a>  cl <span class="ot">=</span> <span class="fu">makeCluster</span>(n_cores)</span>
<span id="cb27-29"><a href="imputation.html#cb27-29" tabindex="-1"></a>  <span class="fu">registerDoSNOW</span>(cl)</span>
<span id="cb27-30"><a href="imputation.html#cb27-30" tabindex="-1"></a>  </span>
<span id="cb27-31"><a href="imputation.html#cb27-31" tabindex="-1"></a>  <span class="co"># Parallel Run</span></span>
<span id="cb27-32"><a href="imputation.html#cb27-32" tabindex="-1"></a>  list_imputation_results <span class="ot">=</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="fu">unique</span>(df_features<span class="sc">$</span>external_id),</span>
<span id="cb27-33"><a href="imputation.html#cb27-33" tabindex="-1"></a>                                    <span class="at">.packages =</span> <span class="fu">c</span>(<span class="st">&#39;mice&#39;</span>,<span class="st">&#39;beepr&#39;</span>, <span class="st">&quot;dplyr&quot;</span>),</span>
<span id="cb27-34"><a href="imputation.html#cb27-34" tabindex="-1"></a>                                    <span class="at">.errorhandling =</span> <span class="st">&#39;pass&#39;</span>,</span>
<span id="cb27-35"><a href="imputation.html#cb27-35" tabindex="-1"></a>                                    <span class="at">.options.snow =</span> opts,</span>
<span id="cb27-36"><a href="imputation.html#cb27-36" tabindex="-1"></a>                                    <span class="at">.verbose =</span> F) <span class="sc">%dopar%</span> {</span>
<span id="cb27-37"><a href="imputation.html#cb27-37" tabindex="-1"></a>    <span class="co"># Run function and log failures</span></span>
<span id="cb27-38"><a href="imputation.html#cb27-38" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb27-39"><a href="imputation.html#cb27-39" tabindex="-1"></a>      <span class="fu">impute_subject</span>(df_features, i, impute_vars )}, </span>
<span id="cb27-40"><a href="imputation.html#cb27-40" tabindex="-1"></a>      <span class="co"># On errror:</span></span>
<span id="cb27-41"><a href="imputation.html#cb27-41" tabindex="-1"></a>      <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb27-42"><a href="imputation.html#cb27-42" tabindex="-1"></a>        <span class="co"># Create error message</span></span>
<span id="cb27-43"><a href="imputation.html#cb27-43" tabindex="-1"></a>        failed_id <span class="ot">&lt;-</span> i</span>
<span id="cb27-44"><a href="imputation.html#cb27-44" tabindex="-1"></a>        error_message <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb27-45"><a href="imputation.html#cb27-45" tabindex="-1"></a>          <span class="st">&quot;Timestamp: &quot;</span>, <span class="fu">Sys.time</span>(),</span>
<span id="cb27-46"><a href="imputation.html#cb27-46" tabindex="-1"></a>          <span class="st">&quot;, Subject_ID: &quot;</span>, failed_id,</span>
<span id="cb27-47"><a href="imputation.html#cb27-47" tabindex="-1"></a>          <span class="st">&quot;, Error: &quot;</span>, e<span class="sc">$</span>message, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb27-48"><a href="imputation.html#cb27-48" tabindex="-1"></a>        <span class="co"># Append the error message to the log file</span></span>
<span id="cb27-49"><a href="imputation.html#cb27-49" tabindex="-1"></a>        <span class="fu">cat</span>(error_message, <span class="at">file =</span> error_log_file, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-50"><a href="imputation.html#cb27-50" tabindex="-1"></a>        </span>
<span id="cb27-51"><a href="imputation.html#cb27-51" tabindex="-1"></a>        <span class="co"># Return NULL for the failed iteration</span></span>
<span id="cb27-52"><a href="imputation.html#cb27-52" tabindex="-1"></a>        <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb27-53"><a href="imputation.html#cb27-53" tabindex="-1"></a>        }</span>
<span id="cb27-54"><a href="imputation.html#cb27-54" tabindex="-1"></a>      )</span>
<span id="cb27-55"><a href="imputation.html#cb27-55" tabindex="-1"></a>  }</span>
<span id="cb27-56"><a href="imputation.html#cb27-56" tabindex="-1"></a>  <span class="fu">stopCluster</span>(cl)</span>
<span id="cb27-57"><a href="imputation.html#cb27-57" tabindex="-1"></a>    </span>
<span id="cb27-58"><a href="imputation.html#cb27-58" tabindex="-1"></a>  <span class="co"># Combine results and make an imputation column</span></span>
<span id="cb27-59"><a href="imputation.html#cb27-59" tabindex="-1"></a>  df_features_imputed <span class="ot">=</span> <span class="fu">rbindlist</span>(list_imputation_results)</span>
<span id="cb27-60"><a href="imputation.html#cb27-60" tabindex="-1"></a>  df_features_imputed<span class="sc">$</span>imputed <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb27-61"><a href="imputation.html#cb27-61" tabindex="-1"></a>  </span>
<span id="cb27-62"><a href="imputation.html#cb27-62" tabindex="-1"></a>  <span class="co"># Subset unimputed subs</span></span>
<span id="cb27-63"><a href="imputation.html#cb27-63" tabindex="-1"></a>  impute_fail_subs <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(df_features<span class="sc">$</span>external_id, df_features_imputed<span class="sc">$</span>external_id)</span>
<span id="cb27-64"><a href="imputation.html#cb27-64" tabindex="-1"></a>  df_features_unimputed <span class="ot">&lt;-</span> df_features[(df_features<span class="sc">$</span>external_id <span class="sc">%in%</span> impute_fail_subs),]</span>
<span id="cb27-65"><a href="imputation.html#cb27-65" tabindex="-1"></a>  df_features_unimputed<span class="sc">$</span>imputed <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb27-66"><a href="imputation.html#cb27-66" tabindex="-1"></a>  </span>
<span id="cb27-67"><a href="imputation.html#cb27-67" tabindex="-1"></a>  <span class="co"># Now put them togerther</span></span>
<span id="cb27-68"><a href="imputation.html#cb27-68" tabindex="-1"></a>  df_features_mix <span class="ot">=</span> <span class="fu">rbind</span>(df_features_imputed, df_features_unimputed, <span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-69"><a href="imputation.html#cb27-69" tabindex="-1"></a>  </span>
<span id="cb27-70"><a href="imputation.html#cb27-70" tabindex="-1"></a>  <span class="co"># # # Impute the ones that didnt work at the between-subject level</span></span>
<span id="cb27-71"><a href="imputation.html#cb27-71" tabindex="-1"></a>  L2_prediction_mat <span class="ot">&lt;-</span> <span class="fu">make_pred_matrix</span>(df_features_mix, <span class="at">impute_vars =</span> impute_vars)<span class="sc">$</span>pred_matrix</span>
<span id="cb27-72"><a href="imputation.html#cb27-72" tabindex="-1"></a>  L2_prediction_mat[, <span class="st">&quot;external_id&quot;</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span></span>
<span id="cb27-73"><a href="imputation.html#cb27-73" tabindex="-1"></a>  mice_imputation_2l <span class="ot">&lt;-</span> <span class="fu">mice</span>(<span class="at">data =</span> df_features_mix,</span>
<span id="cb27-74"><a href="imputation.html#cb27-74" tabindex="-1"></a>                             <span class="at">maxit =</span> <span class="dv">2</span>,</span>
<span id="cb27-75"><a href="imputation.html#cb27-75" tabindex="-1"></a>                              <span class="at">method =</span> <span class="st">&quot;2lonly.pmm&quot;</span>,</span>
<span id="cb27-76"><a href="imputation.html#cb27-76" tabindex="-1"></a>                              <span class="at">seed =</span> <span class="dv">666</span>,</span>
<span id="cb27-77"><a href="imputation.html#cb27-77" tabindex="-1"></a>                              <span class="at">blocks =</span> <span class="fu">as.list</span>(<span class="fu">rownames</span>(L2_prediction_mat)),</span>
<span id="cb27-78"><a href="imputation.html#cb27-78" tabindex="-1"></a>                              <span class="at">predictorMatrix =</span> L2_prediction_mat)</span>
<span id="cb27-79"><a href="imputation.html#cb27-79" tabindex="-1"></a>  </span>
<span id="cb27-80"><a href="imputation.html#cb27-80" tabindex="-1"></a>  df_features_mix <span class="ot">&lt;-</span> <span class="fu">complete</span>(mice_imputation_2l)</span>
<span id="cb27-81"><a href="imputation.html#cb27-81" tabindex="-1"></a>  <span class="co"># Make a day-prompt interaction for later</span></span>
<span id="cb27-82"><a href="imputation.html#cb27-82" tabindex="-1"></a>  df_features_mix<span class="sc">$</span>day_prompt <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">interaction</span>(df_features_mix<span class="sc">$</span>day_nr, df_features_mix<span class="sc">$</span>prompt_num))</span>
<span id="cb27-83"><a href="imputation.html#cb27-83" tabindex="-1"></a>    </span>
<span id="cb27-84"><a href="imputation.html#cb27-84" tabindex="-1"></a>  <span class="co"># Finally save the imputed data frame </span></span>
<span id="cb27-85"><a href="imputation.html#cb27-85" tabindex="-1"></a>  <span class="fu">fwrite</span>(df_features_mix, <span class="at">file =</span> <span class="fu">here</span>(<span class="st">&#39;data&#39;</span>, <span class="st">&#39;df_features_imputed.csv&#39;</span>))  </span>
<span id="cb27-86"><a href="imputation.html#cb27-86" tabindex="-1"></a>    </span>
<span id="cb27-87"><a href="imputation.html#cb27-87" tabindex="-1"></a>  <span class="co"># Now separate the training and test sets</span></span>
<span id="cb27-88"><a href="imputation.html#cb27-88" tabindex="-1"></a>  df_features_mix <span class="ot">=</span> df_features_mix <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(external_id, week_nr, day_nr, imputed) </span>
<span id="cb27-89"><a href="imputation.html#cb27-89" tabindex="-1"></a>  df_ml_train <span class="ot">=</span> df_features_mix <span class="sc">%&gt;%</span> <span class="fu">filter</span>(external_id <span class="sc">%in%</span>  training_set<span class="sc">$</span>external_id)</span>
<span id="cb27-90"><a href="imputation.html#cb27-90" tabindex="-1"></a>  df_ml_test <span class="ot">=</span> df_features_mix <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>(external_id <span class="sc">%in%</span>  training_set<span class="sc">$</span>external_id))</span>
<span id="cb27-91"><a href="imputation.html#cb27-91" tabindex="-1"></a>  <span class="co"># Write the data</span></span>
<span id="cb27-92"><a href="imputation.html#cb27-92" tabindex="-1"></a>  <span class="fu">fwrite</span>(df_ml_train, <span class="at">file =</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;imputed_training.csv&quot;</span>))</span>
<span id="cb27-93"><a href="imputation.html#cb27-93" tabindex="-1"></a>  <span class="fu">fwrite</span>(df_ml_test, <span class="at">file =</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;imputed_testing.csv&quot;</span>))</span>
<span id="cb27-94"><a href="imputation.html#cb27-94" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb27-95"><a href="imputation.html#cb27-95" tabindex="-1"></a>  df_features_mix <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="at">file =</span> <span class="fu">here</span>(<span class="st">&#39;data&#39;</span>, <span class="st">&#39;df_features_imputed.csv&#39;</span>))  </span>
<span id="cb27-96"><a href="imputation.html#cb27-96" tabindex="-1"></a>  df_ml_train <span class="ot">=</span> <span class="fu">fread</span>(<span class="at">file =</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;imputed_training.csv&quot;</span>))</span>
<span id="cb27-97"><a href="imputation.html#cb27-97" tabindex="-1"></a>  df_ml_test <span class="ot">=</span> <span class="fu">fread</span>(<span class="at">file =</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;imputed_testing.csv&quot;</span>))</span>
<span id="cb27-98"><a href="imputation.html#cb27-98" tabindex="-1"></a>}</span></code></pre></div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="descriptives.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="dataset-creation.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

</body>

</html>
